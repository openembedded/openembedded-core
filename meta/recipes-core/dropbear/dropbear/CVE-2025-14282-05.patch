From d193731630a62482855b450daa1d5a5e13a90125 Mon Sep 17 00:00:00 2001
From: Matt Johnston <matt@ucc.asn.au>
Date: Fri, 12 Dec 2025 12:31:40 +0900
Subject: [PATCH] Restore seteuid for authorized_keys

Authorized_keys reading is pre-authentication so should not be
modified in the post-auth drop-privilege change.

Fixes: e0251be2354e ("Drop privileges after user authentication")

CVE: CVE-2025-14282
Upstream-Status: Backport [https://github.com/mkj/dropbear/commit/d193731630a62482855b450daa1d5a5e13a90125]
Signed-off-by: Peter Marko <peter.marko@siemens.com>
---
 src/svr-authpubkey.c | 6 ++----
 1 file changed, 2 insertions(+), 4 deletions(-)

diff --git a/src/svr-authpubkey.c b/src/svr-authpubkey.c
index e26b0ee..94ae728 100644
--- a/src/svr-authpubkey.c
+++ b/src/svr-authpubkey.c
@@ -462,14 +462,12 @@ static int checkpubkey(const char* keyalgo, unsigned int keyalgolen,
 	int ret = DROPBEAR_FAILURE;
 	buffer * line = NULL;
 	int line_num;
-#if !DROPBEAR_SVR_DROP_PRIVS
 	uid_t origuid;
 	gid_t origgid;
-#endif
 
 	TRACE(("enter checkpubkey"))
 
-#if !DROPBEAR_SVR_DROP_PRIVS
+#if DROPBEAR_SVR_MULTIUSER
 	/* access the file as the authenticating user. */
 	origuid = getuid();
 	origgid = getgid();
@@ -490,7 +488,7 @@ static int checkpubkey(const char* keyalgo, unsigned int keyalgolen,
 			TRACE(("checkpubkey: failed opening %s: %s", filename, strerror(errno)))
 		}
 	}
-#if !DROPBEAR_SVR_DROP_PRIVS
+#if DROPBEAR_SVR_MULTIUSER
 	if ((seteuid(origuid)) < 0 ||
 		(setegid(origgid)) < 0) {
 		dropbear_exit("Failed to revert euid");
